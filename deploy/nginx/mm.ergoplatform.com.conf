# Nginx configuration for mm.ergoplatform.com
# ERGO Market Maker Monitoring System
#
# Installation:
#   sudo cp mm.ergoplatform.com.conf /etc/nginx/sites-available/
#   sudo ln -s /etc/nginx/sites-available/mm.ergoplatform.com.conf /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx

server {
    listen 80;
    server_name mm.ergoplatform.com;

    # Redirect HTTP to HTTPS (uncomment after SSL is set up)
    # return 301 https://$server_name$request_uri;

    # Root directory for static files (if any)
    root /var/www/ergo_mm;
    index index.html;

    # CGI scripts location
    location /cgi-bin/ {
        # Point to where your Perl scripts live
        alias /var/www/ergo_mm/cgi-bin/;

        # FastCGI settings for Perl CGI via fcgiwrap
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        include fastcgi_params;

        # Additional FastCGI params for CGI compatibility
        fastcgi_param DOCUMENT_ROOT /var/www/ergo_mm;
        fastcgi_param SERVER_NAME $server_name;
        fastcgi_param REMOTE_ADDR $remote_addr;
        fastcgi_param REQUEST_METHOD $request_method;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param CONTENT_TYPE $content_type;
        fastcgi_param CONTENT_LENGTH $content_length;
    }

    # Convenience redirect: / -> /cgi-bin/dashboard.pl
    location = / {
        return 302 /cgi-bin/dashboard.pl;
    }

    # Health check endpoint (no auth required)
    location = /health {
        return 302 /cgi-bin/api.pl?endpoint=health;
    }

    # Logging
    access_log /var/log/nginx/mm.ergoplatform.com.access.log;
    error_log /var/log/nginx/mm.ergoplatform.com.error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}

# HTTPS server block (uncomment after obtaining SSL certificate)
# server {
#     listen 443 ssl http2;
#     server_name mm.ergoplatform.com;
#
#     # SSL certificate paths (Let's Encrypt)
#     ssl_certificate /etc/letsencrypt/live/mm.ergoplatform.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/mm.ergoplatform.com/privkey.pem;
#
#     # SSL settings
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
#     ssl_prefer_server_ciphers off;
#
#     # Same location blocks as above...
#     root /var/www/ergo_mm;
#     index index.html;
#
#     location /cgi-bin/ {
#         alias /var/www/ergo_mm/cgi-bin/;
#         fastcgi_pass unix:/var/run/fcgiwrap.socket;
#         fastcgi_param SCRIPT_FILENAME $request_filename;
#         include fastcgi_params;
#         fastcgi_param DOCUMENT_ROOT /var/www/ergo_mm;
#         fastcgi_param SERVER_NAME $server_name;
#         fastcgi_param REMOTE_ADDR $remote_addr;
#         fastcgi_param REQUEST_METHOD $request_method;
#         fastcgi_param QUERY_STRING $query_string;
#         fastcgi_param CONTENT_TYPE $content_type;
#         fastcgi_param CONTENT_LENGTH $content_length;
#     }
#
#     location = / {
#         return 302 /cgi-bin/dashboard.pl;
#     }
#
#     location = /health {
#         return 302 /cgi-bin/api.pl?endpoint=health;
#     }
#
#     access_log /var/log/nginx/mm.ergoplatform.com.access.log;
#     error_log /var/log/nginx/mm.ergoplatform.com.error.log;
#
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#     add_header X-XSS-Protection "1; mode=block" always;
# }
